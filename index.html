<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jogo Hebraico Bíblico – Rodrigo Niskier</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css?family=JetBrains+Mono:400,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@400;700&display=swap">
  <style>
    body {
      font-family: 'JetBrains Mono', monospace;
      background: #222c36;
    }
    canvas {
      background: transparent;
      display: block;
      margin: 0 auto;
      touch-action: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    .hebrew {
      font-family: 'Noto Sans Hebrew', sans-serif;
      font-size: 2.2rem;
      direction: rtl;
    }
    .modal-bg {
      background: rgba(0,0,0,0.7);
    }
    .slide-in {
      animation: slide-in 1.1s cubic-bezier(0.4,0,0.2,1);
    }
    @keyframes slide-in {
      from { transform: translateY(-30px); opacity:0; }
      to { transform: translateY(0); opacity:1; }
    }
    .char-choice {
      transition: transform 0.18s;
    }
    .char-choice.selected {
      transform: scale(1.13);
      border: 3px solid #2563eb;
      box-shadow: 0 0 0 4px #2563eb55;
      z-index: 2;
    }
    @media (max-width: 600px) {
      #game { margin-top: 10px !important; }
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen bg-gray-900">

  <!-- Tela Inicial -->
  <div id="startScreen" class="fixed inset-0 bg-gray-950 flex flex-col items-center justify-center z-50">
    <div class="bg-gray-100 rounded-2xl p-8 shadow-2xl flex flex-col items-center gap-6 w-[360px]">
      <h1 class="text-2xl font-bold text-gray-900 mb-2">Bem-vindo ao Jogo de Hebraico Bíblico!</h1>
      <div class="flex flex-col gap-2 w-full">
        <label class="text-gray-800 font-semibold mb-1 text-base" for="username">Seu nome de jogador:</label>
        <input id="username" type="text" maxlength="18" autocomplete="off" class="w-full px-4 py-2 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-blue-500 text-lg text-gray-800" placeholder="Digite seu nome..."/>
      </div>
      <div class="w-full">
        <span class="font-semibold text-gray-800 mb-2 block">Escolha seu personagem:</span>
        <div class="flex flex-row gap-7 justify-center mt-1">
          <button id="char1" class="char-choice rounded-full border-2 border-gray-300 p-1 bg-white focus:outline-none">
            <img src="personagem1.png" alt="Personagem 1" class="w-20 h-20 object-cover rounded-full"/>
          </button>
          <button id="char2" class="char-choice rounded-full border-2 border-gray-300 p-1 bg-white focus:outline-none">
            <img src="personagem2.png" alt="Personagem 2" class="w-20 h-20 object-cover rounded-full"/>
          </button>
        </div>
      </div>
      <button id="playBtn" class="mt-2 w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold shadow hover:bg-blue-700 transition text-lg disabled:bg-gray-300 disabled:text-gray-400 disabled:cursor-not-allowed" disabled>Play</button>
    </div>
  </div>

  <div id="score" class="fixed top-5 right-8 text-xl text-white z-20 bg-gray-700 px-5 py-2 rounded-2xl shadow-lg font-bold flex items-center gap-2" style="display:none;">
    Pontos: <span id="scoreValue">0</span>
  </div>
  <canvas id="game" width="900" height="440" class="rounded-2xl border-2 border-gray-800 shadow-2xl mt-10" style="display:none;"></canvas>

  <!-- Controles Touch para dispositivos móveis -->
  <div id="touchControls" class="fixed left-0 bottom-0 w-full flex justify-between items-end px-6 pb-5 z-30" style="display:none;">
    <div class="flex gap-3">
      <button class="bg-gray-700/80 text-white rounded-full w-16 h-16 text-3xl flex items-center justify-center active:bg-blue-600" id="btnLeft" tabindex="-1">←</button>
      <button class="bg-gray-700/80 text-white rounded-full w-16 h-16 text-3xl flex items-center justify-center active:bg-blue-600" id="btnRight" tabindex="-1">→</button>
    </div>
    <div class="flex gap-3">
      <button class="bg-gray-700/80 text-white rounded-full w-16 h-16 text-3xl flex items-center justify-center active:bg-blue-600" id="btnUp" tabindex="-1">↑</button>
    </div>
  </div>

  <!-- Modal para desafio -->
  <div id="modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="modal-bg absolute inset-0"></div>
    <div class="relative p-8 bg-gray-100 rounded-xl shadow-2xl w-[350px] slide-in">
      <div class="flex flex-col items-center gap-4">
        <span class="text-lg text-gray-900 font-semibold">Traduza a palavra:</span>
        <span id="hebrewWord" class="hebrew text-4xl text-gray-900"></span>
        <form id="answerForm" class="w-full flex flex-col gap-3 items-center">
          <input type="text" id="answerInput" autocomplete="off" placeholder="Digite a tradução..." class="w-full px-4 py-2 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-blue-500 text-lg text-gray-800">
          <div class="flex flex-row gap-4 w-full justify-between items-center">
            <button type="button" id="hintBtn" class="px-3 py-1 bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold rounded-lg transition">Dica</button>
            <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-lg font-semibold shadow hover:bg-blue-700 transition">Responder</button>
          </div>
        </form>
        <div id="feedback" class="text-base text-red-600 font-semibold mt-2 min-h-[28px]"></div>
        <div id="hint" class="text-gray-800 text-sm font-medium"></div>
        <div id="timer" class="text-gray-700 text-xs mt-1"></div>
      </div>
    </div>
  </div>

  <!-- Fim de jogo -->
  <div id="endModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="modal-bg absolute inset-0"></div>
    <div class="relative p-8 bg-white rounded-xl shadow-2xl w-[370px] slide-in text-center">
      <h2 class="text-2xl text-blue-800 font-bold mb-4">Fim de Jogo!</h2>
      <p class="mb-2 text-lg">Parabéns <span id="finalPlayer" class="font-bold text-blue-900"></span>!</p>
      <p class="mb-2 text-lg">Pontuação final: <span id="finalScore" class="font-bold text-blue-700"></span></p>
      <button onclick="window.location.reload()" class="mt-4 px-5 py-2 bg-blue-600 text-white rounded-lg font-semibold shadow hover:bg-blue-700 transition">Jogar novamente</button>
    </div>
  </div>

  <script>
    // ======= Utilitário: Detecta se é dispositivo móvel =======
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // ======= Tela Inicial: seleção de personagem e nome =======
    let selectedChar = 0;
    let playerName = "";
    let usedHint = false;

    const charBtns = [document.getElementById('char1'), document.getElementById('char2')];

    function updatePlayBtnState() {
      document.getElementById('playBtn').disabled = !(playerName.length > 0 && selectedChar > 0);
    }

    charBtns.forEach((btn, idx) => {
      btn.addEventListener('click', () => {
        selectedChar = idx + 1;
        charBtns.forEach((b, j) => b.classList.toggle('selected', j === idx));
        updatePlayBtnState();
      });
    });

    document.getElementById('username').addEventListener('input', function() {
      playerName = this.value.trim();
      updatePlayBtnState();
    });

    document.getElementById('playBtn').addEventListener('click', function() {
      document.getElementById('startScreen').style.display = "none";
      document.getElementById('game').style.display = "";
      document.getElementById('score').style.display = "";
      if (isMobile()) {
        document.getElementById('touchControls').style.display = "flex";
      } else {
        document.getElementById('touchControls').style.display = "none";
      }
      startGame();
    });

    // ======= Palavras e Dicionário =======
    const charImgs = [
      "personagem1.png",
      "personagem2.png"
    ];

    const backgroundImageUrl = "fundo.jpg";

    const WORDS = [
      {he: "בֵּן", tr: "ben", pt: ["filho", "menino", "descendente"], dica: "Começa com 'f' (parentesco masculino)"},
      {he: "אִישׁ", tr: "ish", pt: ["homem", "marido"], dica: "Masculino adulto"},
      {he: "אֵל", tr: "el", pt: ["deus", "Deus"], dica: "Ser supremo ou divino"},
      {he: "מֶלֶךְ", tr: "melekh", pt: ["rei"], dica: "Soberano de um povo"},
      {he: "יָד", tr: "yad", pt: ["mão", "poder"], dica: "Parte do corpo para segurar"},
      {he: "רֹאשׁ", tr: "rosh", pt: ["cabeça", "líder"], dica: "Topo do corpo, ou líder"},
      {he: "אֶרֶץ", tr: "erets", pt: ["terra", "país", "solo", "mundo"], dica: "Planeta, solo, nação"},
      {he: "דָּבָר", tr: "davar", pt: ["palavra", "coisa", "assunto"], dica: "O que se diz ou discute"},
      {he: "עִיר", tr: "ir", pt: ["cidade"], dica: "Conjunto de casas e ruas, urbe"},
      {he: "אָב", tr: "av", pt: ["pai", "ancestral"], dica: "Progenitor masculino"},
      {he: "אֵם", tr: "em", pt: ["mãe"], dica: "Progenitora feminina"},
      {he: "שָׁנָה", tr: "shanah", pt: ["ano"], dica: "Período de 12 meses"},
      {he: "שָׁלוֹם", tr: "shalom", pt: ["paz", "bem-estar", "segurança"], dica: "Desejo de tranquilidade"},
      {he: "שָׁמַיִם", tr: "shamayim", pt: ["céu", "céus"], dica: "Onde estão as nuvens"},
      {he: "מַיִם", tr: "mayim", pt: ["água", "águas"], dica: "Líquido essencial à vida"},
      {he: "אוֹר", tr: "or", pt: ["luz", "claridade"], dica: "Permite enxergar"},
      {he: "עֵין", tr: "ayin", pt: ["olho", "fonte", "vista"], dica: "Sentido da visão"},
      {he: "אָח", tr: "ach", pt: ["irmão"], dica: "Filho do mesmo pai/mãe"},
      {he: "אָדָם", tr: "adam", pt: ["homem", "humanidade", "Adão"], dica: "Primeiro homem ou ser humano"},
      {he: "אָמַר", tr: "amar", pt: ["disse", "dizer", "falou", "falar"], dica: "Ato de expressar palavras"},
      {he: "עָשָׂה", tr: "asah", pt: ["fez", "fazer", "realizar"], dica: "Ato de executar uma tarefa"},
      {he: "רָאָה", tr: "ra'ah", pt: ["viu", "ver", "enxergar"], dica: "Perceber com os olhos"},
      {he: "יָצָא", tr: "yatza", pt: ["saiu", "sair"], dica: "Ir para fora"},
      {he: "יָשַׁב", tr: "yashav", pt: ["sentou", "assentar", "habitou", "morar", "residir"], dica: "Ficar em um lugar"},
      {he: "הָלַךְ", tr: "halakh", pt: ["andou", "andar", "caminhou", "caminhar"], dica: "Locomoção com as pernas"},
      {he: "עָמַד", tr: "amad", pt: ["ficou", "ficar", "permaneceu", "ficar em pé"], dica: "Manter-se parado"},
      {he: "יָדַע", tr: "yada", pt: ["soube", "saber", "conheceu", "conhecer"], dica: "Ter conhecimento"},
      {he: "אָכַל", tr: "akal", pt: ["comeu", "comer"], dica: "Ato de ingerir alimento"},
      {he: "שָׁמַע", tr: "shama", pt: ["ouviu", "ouvir"], dica: "Sentido de escutar"},
      {he: "שָׁבַר", tr: "shavar", pt: ["quebrou", "quebrar", "despedaçou"], dica: "Partiu em pedaços"},
    ];

    function normalize(str) {
      return str
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-zA-Z0-9ãõç\s]/g, '')
        .trim();
    }

    // ======= Engine principal do jogo =======
    let player, cameraX, worldLength, groundY, wordPositions, currentWordIdx, challengeActive, challengeStartTime, points, wordsFound, keys, charImages;
    let challengeTimer = null;
    let challengeTimeout = 16;
    let bgImg = new window.Image();
    bgImg.src = backgroundImageUrl;

    function startGame() {
      player = {
        x: 80,
        y: 320,
        width: 36,
        height: 66,
        vx: 0,
        vy: 0,
        speed: 4.2,
        onGround: true,
        gravity: 0.58,
        jumpPower: -10.6,
        direction: 1
      };
      cameraX = 0;
      worldLength = 3400;
      groundY = 360;
      wordPositions = [];
      currentWordIdx = -1;
      challengeActive = false;
      challengeStartTime = 0;
      points = 0;
      wordsFound = 0;
      keys = {};

      generateWordsOnMap();
      loadCharImages().then(()=>{
        drawWorld();
        setTimeout(() => gameLoop(), 250);
      });
    }

    function loadCharImages() {
      return new Promise(resolve=>{
        charImages = [];
        let img1 = new Image(), img2 = new Image();
        img1.src = charImgs[0];
        img2.src = charImgs[1];
        img1.onload = img2.onload = function() {
          charImages = [img1, img2];
          resolve();
        };
      });
    }

    // Palavras em alturas variadas, sem obstáculos
    function generateWordsOnMap() {
      wordPositions = [];
      let usedIndexes = new Set();
      let numPalavras = 12;
      let baseX = 340;
      let step = 250;
      for (let i = 0; i < numPalavras; i++) {
        let wordIdx;
        do {
          wordIdx = Math.floor(Math.random() * WORDS.length);
        } while (usedIndexes.has(wordIdx) && usedIndexes.size < WORDS.length - 1);
        usedIndexes.add(wordIdx);
        // altura entre 160 e 320 (canvas 440)
        let yWord = 160 + Math.random()*160;
        let xWord = baseX + i * step + Math.random()*50;
        wordPositions.push({x: xWord, y: yWord, idx: wordIdx, found: false});
      }
    }

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    function drawBackground() {
      if(bgImg.complete && bgImg.naturalWidth) {
        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = "#7dd3fc";
        ctx.fillRect(0,0,canvas.width,canvas.height);
      }
      ctx.save();
      ctx.globalAlpha = 0.13;
      ctx.font = "bold 90px JetBrains Mono, monospace";
      ctx.fillStyle = "#2d2d5a";
      ctx.textAlign = "center";
      ctx.fillText("Rodrigo Niskier", canvas.width/2, canvas.height/2+30);
      ctx.restore();
    }

    function drawPlayer() {
  ctx.save();
  let px = player.x - cameraX + player.width/2, py = player.y + player.height/2;
  ctx.translate(px, py);
  ctx.scale(player.direction, 1);

  // -- Ombros e peito (paletó azul escuro) --
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(-21, -4); // ombro esquerdo
  ctx.lineTo(21, -4);  // ombro direito
  ctx.lineTo(15, 36);  // lado direito da cintura
  ctx.lineTo(-15, 36); // lado esquerdo da cintura
  ctx.closePath();
  ctx.fillStyle = "#273262"; // azul escuro
  ctx.fill();
  ctx.strokeStyle = "#182042";
  ctx.lineWidth = 2.2;
  ctx.stroke();
  ctx.restore();

  // -- Braços (paletó azul escuro) --
  ctx.save();
  ctx.lineWidth = 9;
  ctx.strokeStyle = "#273262";
  ctx.beginPath();
  // Braço esquerdo
  ctx.moveTo(-19, 2);
  ctx.lineTo(-29, 34);
  // Braço direito
  ctx.moveTo(19, 2);
  ctx.lineTo(29, 34);
  ctx.stroke();
  // Punhos brancos
  ctx.lineWidth = 6;
  ctx.strokeStyle = "#fff";
  ctx.beginPath();
  ctx.moveTo(-29, 34);
  ctx.lineTo(-29, 38);
  ctx.moveTo(29, 34);
  ctx.lineTo(29, 38);
  ctx.stroke();
  // Mãos bege claro
  ctx.lineWidth = 6;
  ctx.strokeStyle = "#f9e5ce";
  ctx.beginPath();
  ctx.moveTo(-29, 39);
  ctx.lineTo(-29, 43);
  ctx.moveTo(29, 39);
  ctx.lineTo(29, 43);
  ctx.stroke();
  ctx.restore();

  // -- Gravata vermelha --
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(0, -2);    // nó da gravata
  ctx.lineTo(-4, 15);   // lado esquerdo
  ctx.lineTo(4, 15);    // lado direito
  ctx.closePath();
  ctx.fillStyle = "#be2323";
  ctx.fill();
  // Nó pequeno da gravata
  ctx.beginPath();
  ctx.arc(0, -2, 3, 0, 2 * Math.PI);
  ctx.fillStyle = "#a00";
  ctx.fill();
  ctx.restore();

  // -- Camisa branca sob paletó --
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(-7, -4);
  ctx.lineTo(7, -4);
  ctx.lineTo(7, 24);
  ctx.lineTo(-7, 24);
  ctx.closePath();
  ctx.fillStyle = "#fff";
  ctx.fill();
  ctx.restore();

  // -- Pernas (calça preta estilizada) --
  ctx.save();
  ctx.lineWidth = 9;
  ctx.strokeStyle = "#191d25";
  ctx.beginPath();
  ctx.moveTo(-7, 36);
  ctx.lineTo(-10, 63);
  ctx.moveTo(7, 36);
  ctx.lineTo(10, 63);
  ctx.stroke();
  // Sapatos (cinza escuro)
  ctx.lineWidth = 7.5;
  ctx.strokeStyle = "#353942";
  ctx.beginPath();
  ctx.moveTo(-10, 64);
  ctx.lineTo(-10, 67);
  ctx.moveTo(10, 64);
  ctx.lineTo(10, 67);
  ctx.stroke();
  ctx.restore();

  // -- Cabeça (imagem escolhida) --
  ctx.save();
  ctx.beginPath();
  ctx.arc(0, -21, 18, 0, 2 * Math.PI);
  ctx.closePath();
  ctx.clip();
  if (charImages && charImages[selectedChar-1]) {
    ctx.drawImage(charImages[selectedChar-1], -18, -39, 36, 36);
  } else {
    ctx.fillStyle = "#f8e6d4";
    ctx.arc(0, -21, 17, 0, 2 * Math.PI);
    ctx.fill();
  }
  ctx.restore();

  ctx.restore();
}


    function drawGround() {
      ctx.fillStyle = "#222b3e";
      ctx.fillRect(-cameraX, groundY, worldLength+300, canvas.height-groundY);
      ctx.fillStyle = "#495980";
      ctx.fillRect(-cameraX, groundY+30, worldLength+300, canvas.height-groundY-30);
      for(let i=0;i<35;i++){
        ctx.fillStyle = "#94a3b8";
        ctx.fillRect(i*100-30-cameraX, groundY+30, 30, 7);
      }
    }

    function drawWords() {
      wordPositions.forEach((wp) => {
        if (!wp.found) {
          ctx.save();
          ctx.font = "2.5rem 'Noto Sans Hebrew', sans-serif";
          ctx.fillStyle = "#fbbf24";
          ctx.textAlign = "center";
          ctx.shadowColor = "#facc15";
          ctx.shadowBlur = 7;
          ctx.fillText(WORDS[wp.idx].he, wp.x - cameraX + 20, wp.y + 35);
          ctx.restore();
        }
      });
    }

    function drawWorld() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawBackground();
      drawGround();
      drawWords();
      drawPlayer();
      ctx.save();
      ctx.globalAlpha = 0.15;
      ctx.font = "16px monospace";
      ctx.fillStyle = "#fff";
      ctx.fillText(`Pos: ${(player.x|0)}/${worldLength}`, 35, 24);
      ctx.restore();
    }

    function updatePlayer() {
      player.vx = 0;
      if (keys["ArrowLeft"]) { player.vx = -player.speed; player.direction = -1;}
      if (keys["ArrowRight"]) { player.vx = +player.speed; player.direction = 1;}
      if ((keys["ArrowUp"]) && player.onGround) {
        player.vy = player.jumpPower;
        player.onGround = false;
      }
      player.vy += player.gravity;
      player.y += player.vy;
      if (player.y + player.height >= groundY+2) {
        player.y = groundY - player.height + 2;
        player.vy = 0;
        player.onGround = true;
      }
      if (player.y < 80) { player.y = 80; player.vy = 0; }
      player.x += player.vx;
      if (player.x < 0) player.x = 0;
      if (player.x > worldLength-player.width) player.x = worldLength-player.width;
      cameraX = Math.max(0, Math.min(player.x - 350, worldLength - canvas.width + 60));
    }

    function checkWordCollision() {
      if (challengeActive) return;
      for (let i = 0; i < wordPositions.length; i++) {
        let wp = wordPositions[i];
        if (!wp.found &&
            player.x + player.width > wp.x &&
            player.x < wp.x + 54 &&
            player.y + player.height > wp.y &&
            player.y < wp.y + 54) {
          currentWordIdx = i;
          triggerChallenge(wp.idx);
          break;
        }
      }
    }

    // DESAFIO DE PALAVRA
    function triggerChallenge(wordIdx) {
      challengeActive = true;
      usedHint = false;
      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('hebrewWord').textContent = WORDS[wordIdx].he;
      document.getElementById('answerInput').value = "";
      document.getElementById('feedback').textContent = "";
      document.getElementById('hint').textContent = "";
      document.getElementById('answerInput').focus();
      document.getElementById('hintBtn').disabled = false;
      challengeStartTime = performance.now();
      let timerEl = document.getElementById('timer');
      timerEl.textContent = `Tempo: ${challengeTimeout.toFixed(1)}s`;
      let secondsElapsed = 0;
      clearInterval(challengeTimer);
      challengeTimer = setInterval(() => {
        let now = performance.now();
        secondsElapsed = (now - challengeStartTime)/1000;
        let left = Math.max(0, challengeTimeout - secondsElapsed);
        timerEl.textContent = `Tempo: ${left.toFixed(1)}s`;
        if (left <= 0) {
          clearInterval(challengeTimer);
          failChallenge();
        }
      }, 90);
    }

    document.getElementById('hintBtn').addEventListener('click', function() {
      if (challengeActive && !usedHint) {
        let idx = wordPositions[currentWordIdx].idx;
        document.getElementById('hint').textContent = WORDS[idx].dica || "Sem dica.";
        usedHint = true;
        this.disabled = true;
      }
    });

    document.getElementById('answerForm').addEventListener('submit', function(e){
      e.preventDefault();
      if (!challengeActive) return;
      let answer = normalize(document.getElementById('answerInput').value);
      let word = WORDS[wordPositions[currentWordIdx].idx];
      let accepted = word.pt.some(t => normalize(t) === answer);
      if (accepted) {
        completeChallenge();
      } else {
        document.getElementById('feedback').textContent = "Tradução incorreta. Tente novamente!";
      }
    });

    function completeChallenge() {
      let timeTaken = (performance.now() - challengeStartTime)/1000;
      let pts = Math.round(
        usedHint ?
          Math.max(10, 60 - 3.5*timeTaken) :
          Math.max(20, 100 - 5*timeTaken)
      );
      points += pts;
      wordsFound++;
      wordPositions[currentWordIdx].found = true;
      document.getElementById('scoreValue').textContent = points;
      document.getElementById('feedback').textContent = usedHint
        ? `Correto! +${pts} pts (com dica)`
        : `Correto! +${pts} pts`;
      setTimeout(()=>{
        document.getElementById('modal').classList.add('hidden');
        challengeActive = false;
        if (wordsFound === wordPositions.length) {
          endGame();
        }
      }, 600);
      clearInterval(challengeTimer);
    }

    function failChallenge() {
      document.getElementById('feedback').textContent = `Tempo esgotado! Resposta: ${WORDS[wordPositions[currentWordIdx].idx].pt[0]}`;
      setTimeout(()=>{
        document.getElementById('modal').classList.add('hidden');
        challengeActive = false;
        wordsFound++;
        wordPositions[currentWordIdx].found = true;
        if (wordsFound === wordPositions.length) {
          endGame();
        }
      }, 1200);
      clearInterval(challengeTimer);
    }

    function endGame() {
      document.getElementById('finalScore').textContent = points;
      document.getElementById('finalPlayer').textContent = playerName;
      document.getElementById('endModal').classList.remove('hidden');
    }

    function gameLoop() {
      if (!challengeActive) {
        updatePlayer();
        checkWordCollision();
      }
      drawWorld();
      requestAnimationFrame(gameLoop);
    }

    // ======= Controles de teclado (setas de direção) =======
    document.addEventListener('keydown', function(e){
      if (["ArrowUp", "ArrowLeft", "ArrowRight"].includes(e.code)) {
        keys[e.code] = true;
      }
      if (challengeActive && e.code === "Escape") {
        document.getElementById('modal').classList.add('hidden');
        challengeActive = false;
        clearInterval(challengeTimer);
      }
    });
    document.addEventListener('keyup', function(e){
      if (["ArrowUp", "ArrowLeft", "ArrowRight"].includes(e.code)) {
        keys[e.code] = false;
      }
    });

    // ======= Controles Touch (mobile) =======
    if (document.getElementById('btnLeft')) {
      let btns = [
        {id: 'btnLeft', code: 'ArrowLeft'},
        {id: 'btnRight', code: 'ArrowRight'},
        {id: 'btnUp', code: 'ArrowUp'}
      ];
      btns.forEach(({id, code}) => {
        let btn = document.getElementById(id);
        let timer;
        btn.addEventListener('touchstart', function(e) {
          e.preventDefault();
          keys[code] = true;
          timer = setInterval(()=>{ keys[code]=true; }, 80);
        }, {passive: false});
        btn.addEventListener('touchend', function(e) {
          e.preventDefault();
          keys[code] = false;
          if (timer) clearInterval(timer);
        }, {passive: false});
        btn.addEventListener('touchcancel', function(e) {
          keys[code] = false;
          if (timer) clearInterval(timer);
        }, {passive: false});
      });
    }

    // ======= Responsividade do Canvas =======
    function adjustCanvas() {
      let ww = Math.min(window.innerWidth-10, 900);
      let wh = Math.max(320, Math.min(window.innerHeight-100, 500));
      canvas.width = ww;
      canvas.height = wh;
    }
    window.addEventListener('resize', adjustCanvas);
    adjustCanvas();
  </script>
</body>
</html>
